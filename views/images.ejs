<!DOCTYPE html>
<html>
	<head>
		<title><%= lingua.title %></title>

		<% include meta %>

		<link rel='stylesheet' href='/stylesheets/style.css' />

		<script src="/socket.io/socket.io.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
		<script type="text/javascript" src="/js/jquery.wookmark.js"></script>

		<script src="/js/vivagraph.js"></script>
		<script src="/js/lsse.js"></script>

		<script>
			

			var advanced = false;
			var lingua = {
				not_found: "<%= lingua.search.not_found %>",
				not_found_try_perhaps: "<%= lingua.search.not_found_try_perhaps %>",
				results_count: "<%= lingua.search.results_count %>",
				results: ["<%= lingua.search.results.one %>", "<%= lingua.search.results.two %>", "<%= lingua.search.results.many %>"],
				show_images: "<%= lingua.nav.show_images %>",
				hide_images: "<%= lingua.nav.hide_images %>",
				hide_second_links: "<%= lingua.nav.hide_second_links %>",
				show_second_links: "<%= lingua.nav.show_second_links %>"
			};
			var defaultModel = 'norm60-corpus-all';

			$(function(){
				$('#model').val(defaultModel);

				$('#graph_container>div').hide();

			});

			var currentPage = 'images_search';
			
		</script>

		<script src="/js/search.js"></script>
		<script src="/js/visualization.js"></script>
		
		<style type="text/css">
		#result
		{
			width: auto;
			margin-top: 20px;
		}

		#result ul.images_search 
		{
			list-style-type: none;
			position: relative;
			margin: 0;
		}
		#result ul.images_search li
		{
			display: inline-block;
			width: 250px;
			height: 250px;
			overflow: hidden;
			background-repeat: no-repeat;
			background-position: center;
			margin: 5px;
			position: relative;
		}

		#result ul.images_search li img 
		{
			position: absolute;
		}
		#result ul.images_search li div
		{
			position: absolute;
			bottom: 0;
			height: 50px;
			background-color: rgba(20, 20, 20, 0.8);
			color: #FFF;
			font-size: 20px;
			padding: 10px;
			width: 100%;
			cursor: pointer;
		}
	/*	#result ul.images_search li img 
		{
			display: block;
			max-height: 250px;
			max-width: 250px;
		}*/
		</style>

		<% include counters %>

	</head>
	<body>
		<% include nav %>
		<h2><%= lingua.title %></h2>
		
		<form action="?" id="input_form">
			<input type="text" placeholder="<%= lingua.search.input_word %>" id="input_word" autocomplete='off' />
			<input type="hidden" name="model" id="model" />
			<input type="submit" value="<%= lingua.search.search %>" />
			<div id="example_search"><%- lingua.search.for_example %>, <a href="#fruit">fruit</a></div>
			<ul id="suggest_results">
				<li>dog</li>
				<li>cat</li>
				<li>human</li>
			</ul>
		</form>

		<div id="result">

		</div>
		<a href="#show_all" id="show_all"><%= lingua.search.show_all %></a>

		<% include social %>

		<script>
			displayResults = function(data)
			{
				var html = "";
				if (data.totalRelations > 0)
				{
					if (currentSkip == 0)
						html = '<ul class="images_search">';

					for(i = 0; i < data.relations.length; i++)
					{

						html += ('<li><img src="http://' + data.relations[i].word.replace(/\s+/g, '_') + '.jpg.to/m" />'+

								'<div data-word="' + data.relations[i].word + '">' + (currentSkip + i + 1) + '. ' + data.relations[i].word + '</a></div>' +

							'</li>');
					}

					if (currentSkip == 0)
						html += '</ul>';
					html = $(html);

					html.imagesLoaded(function() {
						this.find('img').each(function(){
							var i = $(this);
							var w = i.width();
							var h = i.height();
							
							if (w > h)
							{
								w = w * (250/h);
								i.css({
									height: '250px',
									left: (250 - w)/2 + 'px'
								});
							}	
							else
							{
								h = h * (250/w);
								i.css({
									width: '250px',
									top: (250 - h)/2 + 'px'
								});
							}
						});
					});

					if (currentSkip == 0)
						$('#result').empty().append(html);
					else
						$('#result ul.images_search').append(html);
					
					html.find('div').click(function(){
						var word = $(this).data('word');
						if (word)
							location.hash = word;
					});
					// $('#result ul.images_search').imagesLoaded(function() {
					// 	$('#result li').wookmark({
					// 		container: $('#result'),
					// 		offset: 2, // Optional, the distance between grid items
     //   						itemWidth: 210
					// 	});
					// });
					
				}

			}

			$(function(){


				$(document).bind('scroll', function(){
					if  $(window).scrollTop() + $(window).height() > $(document).height() - 100)
					{
						currentSkip += 20;

						lsse.search($('#input_word').val(), $('#model').val(), currentSkip, 20, displayResults);
					}
				});
			});

			$.fn.imagesLoaded = function( callback ){
			  var elems = this.find( 'img' ),
			      elems_src = [],
			      self = this,
			      len = elems.length;

			  if ( !elems.length ) {
			    callback.call( this );
			    return this;
			  }

			  elems.one('load error', function() {
			    if ( --len === 0 ) {
			      // Rinse and repeat.
			      len = elems.length;
			      elems.one( 'load error', function() {
			        if ( --len === 0 ) {
			          callback.call( self );
			        }
			      }).each(function() {
			        this.src = elems_src.shift();
			      });
			    }
			  }).each(function() {
			    elems_src.push( this.src );
			    // webkit hack from http://groups.google.com/group/jquery-dev/browse_thread/thread/eee6ab7b2da50e1f
			    // data uri bypasses webkit log warning (thx doug jones)
			    this.src = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";
			  });

			  return this;
			};
		</script>
	</body>
</html>
